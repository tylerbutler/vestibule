name: Changie Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          token: ${{ secrets.RELEASE_PAT }}

      - uses: tylerbutler/actions/changie-release@4a9f30cbf656e1fba6e02379e05efcf4aa3f6fc2 # ratchet:tylerbutler/actions/changie-release@main
        id: release
        with:
          token: ${{ secrets.RELEASE_PAT }}
          projects: vestibule,vestibule_apple,vestibule_google,vestibule_microsoft,vestibule_wisp
          version-files: |
            vestibule:gleam.toml:version
            vestibule_apple:packages/vestibule_apple/gleam.toml:version
            vestibule_google:packages/vestibule_google/gleam.toml:version
            vestibule_microsoft:packages/vestibule_microsoft/gleam.toml:version
            vestibule_wisp:packages/vestibule_wisp/gleam.toml:version

      - name: Summary
        if: steps.release.outputs.skipped != 'true'
        env:
          VERSION: ${{ steps.release.outputs.version }}
          PR_URL: ${{ steps.release.outputs.pr-url }}
          PR_OP: ${{ steps.release.outputs.pr-operation }}
          BATCHED: ${{ steps.release.outputs.batched-projects }}
        run: |
          echo "### Release PR Created" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Versions:** $VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Batched projects:** $BATCHED" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR:** $PR_URL" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Operation:** $PR_OP" >> "$GITHUB_STEP_SUMMARY"

      - name: Skipped
        if: steps.release.outputs.skipped == 'true'
        run: |
          echo "### Release Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "No unreleased change fragments found." >> "$GITHUB_STEP_SUMMARY"
